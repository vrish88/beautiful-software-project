<html>
  <head>
    <meta charset="utf-8" />
  </head>
  <script type="text/javascript">
    const feelings = [];
    let callback = () => {};
    var feelingsStore = {
      push: (data) => {
        feelings.push(data);
        callback(feelingsStore);
      },
      getFeelings: () => feelings,
      registerCallback: (c) => (callback = c),
    };
  </script>
  <body>
    <h1>Beautiful Software</h1>
    <main>
      <h2>Feeling Assessment Where You Are</h2>
      <form id="feeling-form">
        <label>
          feeling
          <input type="range" name="feeling-intensity" min="0" max="5" />
        </label>
        <input type="submit" value="Submit" />
      </form>

      <script type="text/javascript">
        document.getElementById("feeling-form").onsubmit = function (e) {
          e.preventDefault();

          navigator.geolocation.getCurrentPosition(function (position) {
            let lat = position.coords.latitude;
            let long = position.coords.longitude;

            feelingsStore.push({
              intensity: new FormData(e.target).get("feeling-intensity"),
              lat: lat,
              long: long,
            });
          });
        };
      </script>
    </main>

    <main>
      <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js"></script>
      <link
        href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.css"
        rel="stylesheet"
      />

      <style type="text/css">
        #map {
          height: 180px;
          width: 100%;
        }
      </style>

      <h2>Mapping of Feeling</h2>
      <button id="load-map">Load Map</button>

      <div id="map"></div>

      <script type="text/javascript">
        mapboxgl.accessToken =
          "pk.eyJ1IjoidnJpc2g4OCIsImEiOiJja3VzeTUydXQ1amlmMm5xamI3cWZ5Ym5xIn0.ufgWhRNVhyE9h7RLJegG0w";

        const loadFeelingData = (mapSource, feelings) => {
          mapSource.setData({
            type: "FeatureCollection",
            features: feelings.map((f) => ({
              type: "Feature",
              properties: { intensity: f.intensity },
              geometry: {
                type: "Point",
                coordinates: [f.long, f.lat],
              },
            })),
          });
        };

        document.getElementById("load-map").onclick = function () {
          navigator.geolocation.getCurrentPosition(function (position) {
            let lat = position.coords.latitude;
            let long = position.coords.longitude;
            console.log(position.coords);
            const map = new mapboxgl.Map({
              container: "map",
              style: "mapbox://styles/mapbox/dark-v10",
              center: [long, lat],
              zoom: 15,
            });

            map.on("load", () => {
              map.addSource("feelings", {
                type: "geojson",
                data: {
                  type: "FeatureCollection",
                  features: [],
                },
              });
              map.addLayer(
                {
                  id: "feelings-heat",
                  type: "heatmap",
                  source: "feelings",
                  maxzoom: 20,
                  paint: {
                    // increase weight as diameter breast height increases
                    "heatmap-weight": {
                      property: "intensity",
                      type: "exponential",
                      stops: [
                        [1, 0],
                        [62, 1],
                      ],
                    },
                    // increase intensity as zoom level increases
                    "heatmap-intensity": {
                      stops: [
                        [11, 1],
                        [15, 3],
                      ],
                    },
                    // assign color values be applied to points depending on their density
                    "heatmap-color": [
                      "interpolate",
                      ["linear"],
                      ["heatmap-density"],
                      0,
                      "rgba(236,222,239,0)",
                      0.2,
                      "rgb(208,209,230)",
                      0.4,
                      "rgb(166,189,219)",
                      0.6,
                      "rgb(103,169,207)",
                      0.8,
                      "rgb(28,144,153)",
                    ],
                    // increase radius as zoom increases
                    "heatmap-radius": {
                      stops: [
                        [11, 15],
                        [15, 20],
                      ],
                    },
                    // decrease opacity to transition into the circle layer
                    "heatmap-opacity": {
                      default: 1,
                      stops: [
                        [14, 1],
                        [15, 0],
                      ],
                    },
                  },
                },
                "waterway-label"
              );
              loadFeelingData(
                map.getSource("feelings"),
                feelingsStore.getFeelings()
              );
            });
          });

          feelingsStore.registerCallback(() => {});
        };
      </script>
    </main>

    <aside>
      <h2>Proposed Sequence</h2>
      <ol>
        <li>
          <h3>Technical aspects</h3>
          <p>Local transient data</p>

          <h3>User context</h3>
          <p>
            Some place where there is data already existing. So presumably
            outdoors. Focused on capturing "How do you feel right here right
            now?"
          </p>
        </li>
        <li>
          <h3>Technical aspects</h3>
          <p>Persisted global data</p>

          <h3>User context</h3>
          <p>Aggregating the global results into a global map.</p>
        </li>
      </ol>

      <h2>Curating Moments of Good Creation</h2>
    </aside>
  </body>
</html>
